<!DOCTYPE html>
<html>
  <head>
    <title>For the Moon is Hollow and I Have Touched the Sky</title>
    <meta http-equiv="Pragma" content="no-cache, no-store" />
    <meta http-equiv="Expires" content="31 Dec 1997" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bacon.js/3.0.13/Bacon.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ramda/0.25.0/ramda.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
    <script type="text/javascript">

      const cjs = createjs;

      //--------------------------------------------------------------------------- buildDashboard
      function buildDashboard(DEAD_CENTER, viewPortSize){

	  let dash = new cjs.Container();

	  let viewportFrame = new cjs.Shape();
	  viewportFrame.graphics
	      .s("#ff0000")
	      .dr((0 - (viewPortSize.w/2)),
		  (0 - (viewPortSize.h/2)),
		  viewPortSize.w,
		  viewPortSize.h)
	  viewportFrame.x = DEAD_CENTER.x;
	  viewportFrame.y = DEAD_CENTER.y;	  

	  let sighting = new cjs.Shape();
	  sighting.graphics
	      .s("#ff0000")
	      .dc(0,0,60)
	  sighting.x = DEAD_CENTER.x;
	  sighting.y = DEAD_CENTER.y;

	  dash.addChild(viewportFrame)
	  dash.addChild(sighting)	  

	  return dash;
      }

      
      //--------------------------------------------------------------------------- init
      function init(){

	  let keys = {arrowup:0, arrowdown:0, arrowleft:0, arrowright:0};

	  document.onkeydown = (e) => {
	      if(e.repeat){return;};
	      let k = e.key.toLowerCase();
	      if(keys.hasOwnProperty(k)){ keys[k] = 1; };
	  };
	  document.onkeyup = (e) => {
	      if(e.repeat){return;};
	      let k = e.key.toLowerCase();
	      if(keys.hasOwnProperty(k)){ keys[k] = 0; };
	  };
	  
          cjs.Ticker.framerate = 60;
          cjs.Ticker.timingMode = cjs.Ticker.RAF;
          
          let stage = new cjs.Stage("canvas1");
          cjs.Ticker.addEventListener('tick', stage);
          stage.x = stage.y = 0.5;


	  const DEAD_CENTER = {
	      x:(stage.canvas.width/2),
	      y:(stage.canvas.height/2)
	  };

	  let trackpoint = { x: DEAD_CENTER.x, y: DEAD_CENTER.y };
	  
	  const viewPortSize = {w:650, h:350}
	  
	  let dash = buildDashboard(DEAD_CENTER, viewPortSize);
	  
	  let moon1 = new cjs.Container();
	  moon1.x = DEAD_CENTER.x;
	  moon1.y = DEAD_CENTER.y;	  	  

	  let moon2 = new cjs.Container();
	  moon2.x = DEAD_CENTER.x;
	  moon2.y = DEAD_CENTER.y;	  

	  var texture = new cjs.Bitmap(queue.getResult("texture"));
	  texture.x = - 1816;
	  texture.y = - 1816;

	  var texture2 = texture.clone();
	  texture2.x = - 1816;
	  texture2.y = - 1816;
	  
	  var shadow = new cjs.Bitmap(queue.getResult("shadow"));
	  shadow.x = - 1816;
	  shadow.y = - 1816;	  
	  
	  
	  const MIN_SIZE = 400;
	  
	  let blackCircle = new cjs.Shape();
	  blackCircle.graphics.s("#fff").f("#333").dc(0,0, MIN_SIZE)
	  
	  let mask = new cjs.Shape();
	  mask.graphics
	      .f("#000000")
              .dc(0,0,100)

	  mask.x = moon2.x + 400;
          mask.y = moon2.y;

	  let trackdot = new cjs.Shape();
	  trackdot.graphics.f("#ff0000").dc(0,0,6)
	  trackdot.x = 200
	  
	  moon1.addChild(texture);
	  moon1.addChild(shadow);	  	  
	  moon1.addChild(trackdot);
	  
	  mask.scale = 0.1;
	  
	  moon2.addChild(texture2);
	  moon2.addChild(blackCircle);	  
	  moon2.mask = mask;

	  stage.addChild(moon1);
	  stage.addChild(moon2);	  		   	  
	  stage.addChild(dash);	  		   

//	  moon1.scale = 0.25;

	  let SSS = 0.25
	  
	  cjs.Tween.get({scale:0.2}).wait(500).to({scale:1.5}, (20 * 1000)).addEventListener("change", (evt) => {
	      let s = evt.target.target.scale;
	      SSS = s;

	      mask.scale = s;
	  });

	  cjs.Tween.get(moon1).wait(500).to({rotation:90}, (20 * 1000))
	  cjs.Tween.get(blackCircle).wait(500).to({alpha:0}, (20 * 1000))
	  

          cjs.Ticker.addEventListener('tick', function(){

	      if(keys.arrowdown) { trackpoint.y-=2 };
	      if(keys.arrowup)   { trackpoint.y+=2 };
	      if(keys.arrowleft) { trackpoint.x+=2 };
	      if(keys.arrowright){ trackpoint.x-=2 };

	      let MAX_W = ((moon1.scale * 3632)/2) - (viewPortSize.w/2);
	      let MAX_H = ((moon1.scale * 3632)/2) - (viewPortSize.h/2);
	      
	      if(trackpoint.x > DEAD_CENTER.x + MAX_W){ trackpoint.x = DEAD_CENTER.x + MAX_W; };
	      if(trackpoint.x < DEAD_CENTER.x - MAX_W){ trackpoint.x = DEAD_CENTER.x - MAX_W; };
	      if(trackpoint.y > DEAD_CENTER.y + MAX_H){ trackpoint.y = DEAD_CENTER.y + MAX_H; };
	      if(trackpoint.y < DEAD_CENTER.y - MAX_H){ trackpoint.y = DEAD_CENTER.y - MAX_H; };

	      moon1.scale = SSS;
	      moon1.x = trackpoint.x;
	      moon1.y = trackpoint.y;
	      
	      let pt = moon1.localToGlobal(trackdot.x, trackdot.y);
	      mask.x = pt.x;
	      mask.y = pt.y;
	  });	  
	  
      }
	  

	  // function distance(pt1, pt2) {  
	  // return Math.sqrt(Math.pow((pt1.x - pt2.x), 2) + Math.pow((pt1.y - pt2.y), 2));
	  // };


    var queue = new createjs.LoadQueue(true);
    queue.on("complete", function(){ init(); });    
    queue.on("error", function(e){ console.log(e); });    
    queue.loadManifest([
        {id:"texture", src:"moonOpt.jpg"},
        {id:"shadow", src:"shadow.png"}	
    ]);
      
    </script>

    <style>
      body {
          font-family: arial;
          font-size:16px;
          color:#222;
          text-align:center;
      }
      canvas { border:1px solid #000; display:block; margin:0px auto;}
    </style>

  </head>
  <body>

    
    <!-- <canvas id="canvas1" width="1200" height="800"></canvas> -->
    <!-- <canvas id="canvas1" width="650" height="350"></canvas> -->

    <canvas id="canvas1" width="1200" height="800"></canvas>
    
  </body>
</html>
